name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'destroy' to confirm"
        required: true
        default: "destroy"

jobs:
  destroy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::255945442255:role/GITHUB_OIDC_ROLE
          aws-region: us-east-1

      - name: Terraform Init
        run: terraform init

      - name: Terraform Destroy
        if: ${{ github.event.inputs.confirm == 'destroy' }}
        run: |
          echo "Destroying resources..."
          terraform destroy -auto-approve
          # Optional AWS CLI cleanup for leftover resources
          aws ecs delete-service --cluster shilpa-ecs --service shilpa-ecs-task-def --force || true
          aws ecs delete-cluster --cluster shilpa-ecs || true
          aws ecr delete-repository --repository-name shilpa-ecr --force || true
          aws ec2 delete-security-group --group-id sg-054725d78b04fec94 || true
          aws logs delete-log-group --log-group-name /aws/ecs/shilpa-ecs || true
